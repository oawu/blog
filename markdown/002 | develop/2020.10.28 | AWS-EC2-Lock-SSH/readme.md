# EC2 è¢«é–ä½ä¸èƒ½ä½¿ç”¨ SSH ç™»å…¥ æ€éº¼è¾¦ï¼Ÿ

ä¸å°å¿ƒå¼„éŒ¯è¨­å®šï¼Œé€ æˆ root æ¬Šé™çš„ ubuntu ç„¡æ³• SSH ç™»å…¥äº†ï¼Œæ€è¾¦ï¼Ÿæœ‰è¾¦æ³•æ¶æ•‘å—ï¼Ÿ


## ç·£èµ·

ç‚ºäº†é™åˆ¶ AWS EC2 ä¸ŠæŸå€‹ user åƒ…èƒ½ä½¿ç”¨ **sftp** åœ¨è‡ªå·±çš„ **å®¶ç›®éŒ„** å…§é‹ä½œï¼Œæ–¼æ˜¯æˆ‘æ›´æ”¹ Server çš„ `sshd_config`ï¼ŒåŠ å…¥äº†å°è©² **user** çš„ `ChrootDirectory`ã€`ForceCommand` èˆ‡ `AllowTcpForwarding` è¨­å®šã€‚

ä½†æ‰‹æ®˜å»ä¸å°å¿ƒæŠŠ `Match User` è¨»è§£äº†..

å¦‚æ­¤ä¸€ä¾†æœƒé€ æˆæ‰€æœ‰ User çš†åªèƒ½ä½¿ç”¨ sftp é€£ä¸Š Serverï¼Œä¸¦ä¸”æ ¹ç›®éŒ„åƒ…èƒ½åœ¨è‡ªå·±çš„ **å®¶ç›®éŒ„** å…§ï¼Œè€Œä¸” **ä¸èƒ½å¾€ä¸Šå±¤ç§»å‹•** ğŸ˜¢


## è™•ç†éç¨‹

ä»¥ä¸‹æ˜¯æˆ‘è©¦åœ–æ¶æ•‘çš„éç¨‹ï¼Œä¸æ˜¯ä¸€å€‹æœ€ä½³çš„æ–¹å¼ï¼Œå¦‚è¦äº†è§£æœ€é©åˆçš„æ–¹æ³•å¯ä»¥ç›´æ¥çœ‹ä¸‹æ–¹çµè«–ï½

é¦–å…ˆ root æ¬Šé™çš„ ubuntu å› ç‚º `sshd_config` çš„è¨­å®šå€¼é—œä¿‚æ‰€ä»¥ç„¡æ³• SSH ä¸Š server

æ¯ç•¶ä½¿ç”¨ SSH é€£ç·šæ™‚ï¼Œå°±æœƒæœ‰éŒ¯èª¤è¨Šæ¯ï¼š`This service allows sftp connections only.`

æ‰€ä»¥ SSH é€™æ¢è·¯ç®—æ˜¯å°æ­»äº†..



é‚£è©¦è‘— `sftp` ä¸Šå»çœ‹èƒ½ä¸èƒ½ä¿®æ”¹èˆ‡æ›´æ–° `sshd_config`ï¼Œç„¶å¾Œ **é‡å•Ÿ** ä¸Šç³»çµ±è‡ªå‹• `ssh reload`

ä½†æ˜¯ç”±æ–¼ **ä¸èƒ½å¾€ä¸Šå±¤ç§»å‹•** çš„é™åˆ¶ï¼Œè‡ªç„¶çš„ä¹Ÿå°±ç„¡æ³•è®Šæ›´åˆ° `sshd_config` ğŸ˜«

è¬å¿µä¿±ç°ä¹‹ä¸‹é‚„å˜—è©¦äº†å°‡ Server build å‡º `image`ï¼Œæƒ³è—‰ç”± image launch æ–°çš„ EC2 instance

çµæœç•¶ç„¶å¤±æ•—ï¼Œå› ç‚ºæ—¢ç„¶æ˜¯ image..ï¼Œæ‰€ä»¥è¨­å®šå€¼ä¸€æ¨¡ä¸€æ¨£ï¼ŒSSH ä¸Šé€™å°æ–°çš„ instance ä¹Ÿæ˜¯ä¸€æ¨£çš„éŒ¯èª¤è¨Šæ¯ `This service allows sftp connections only.`

æ‰€ä»¥ image æ–¹å¼ä¹Ÿæ˜¯å¤±æ•—..



## å‚™ä»½è³‡æ–™

æ—¢ç„¶ç„¡æ³•é€²å» Serverï¼Œé‚£æ›å€‹è§’åº¦ï¼Œè‡³å°‘è¦æƒ³è¾¦æ³•å‚™ä»½è³‡æ–™å§ï¼Ÿ

é›–ç„¶ç¨‹å¼ç¢¼éƒ½æœ‰ä¸Š gitï¼Œä½†æ˜¯å¾ˆå¤š config éƒ½æ˜¯è¢« gitignore çš„ï¼Œå¦‚æœéºå¤±å‹¢å¿…éº»ç…©..



æ­¤æ™‚æˆ‘æƒ³èµ· AWS EC2 çš„æœå‹™æ˜¯æ‹†æˆ

1. é‹ç®—
2. å„²å­˜

æ‰€ä»¥æ”¶è²»æ™‚æœ‰ä¸‰å€‹æ”¶è²»é …ç›®

1. é‹ç®—
2. å„²å­˜
3. æµé‡

é‚£ä»£è¡¨å„²å­˜æ˜¯ç¨ç«‹åˆ‡é–‹çš„ï¼Œè€Œä¸”è³‡æ–™æ˜¯å„²å­˜åœ¨ EC2 çš„ç¡¬ç¢Ÿä¸Šçš„ï¼Œä¹Ÿå°±æ˜¯ **Volume**ï¼Œé‚£å°±æŠŠè…¦ç­‹å‹•åˆ° Volume ä¸Šå§ï¼

![](img/01.jpg)



### è¤‡è£½ Volume

ä»¥æˆ‘é€™å°ä¸»è¦çš„ EC2 `i-xxx` çš„æ©Ÿå™¨ä¾†èªªï¼Œæ‰€æ­é…çš„ç¡¬ç¢Ÿæ˜¯ `vol-xxx`ï¼Œå¦‚ä¸‹åœ– **1** ä»£è¡¨çš„å°±æ˜¯ç™¼ç”Ÿå•é¡Œçš„ EC2 instanceï¼Œè€Œæ¨™ç¤º **3** å‰‡æ˜¯é€™å° EC2 æ‰€æ›è¼‰çš„ Volume `vol-xxx`

![](img/02.jpg)


é»æ“Šæ¨™ç¤º 3 çš„ `vol-xxx` ID å¾Œæœƒè·³è‡³ Volumes é é¢ï¼Œæª¢è¦–å…¶ç´°ç¯€ï¼Œå¦‚ä¸‹åœ–å¯ä»¥å¾—çŸ¥ç•¶åˆæˆ‘ä¸¦æœªå°ç¡¬ç¢Ÿåº§åŠ å¯†ï¼Œæ‰€ä»¥çœ‹ä¾†æ˜¯æœ‰æ©Ÿæœƒçš„å¯ä»¥è®€å‡ºå…§å®¹

![](img/03.jpg)


æ–¹æ³•å°±æ˜¯å°‡æ­¤ `vol-xxx` çš„ volume clone ä¸€ä»½å‡ºä¾†ï¼Œä¸¦ä¸”é–‹å•Ÿå¦ä¸€å° EC2 instance `i-ooo` ç„¶å¾Œæ›è¼‰ä¸Šå»ï¼

é¦–å…ˆå°é€™å€‹ `vol-xxx` å³éµé¸æ“‡ `Create Snapshot`ï¼Œå»ºç«‹ä¸€ä»½æ­¤ Volume çš„ **å¿«ç…§**

![](img/04.jpg)


ç„¶å¾Œé»æ“Šå» Snapshots é é¢ä¸Šçœ‹æ‰€ç”¢ç”Ÿçš„ Volume Snapshot

![](img/05.jpg)


å¦‚ä¸‹åœ–å°±æ˜¯ `vol-xxx` æ‰€ç”¢ç”Ÿçš„å¿«ç…§ `snap-xxx`

![](img/06.jpg)


ç„¶å¾Œå°è‘— `snap-xxx` å³éµé¸æ“‡ `Create Volume`ï¼Œå»ºç«‹ä¸€ä»½èˆ‡åŸæœ¬ä¸€æ¨£çš„ Volume

![](img/07.jpg)


å›åˆ° Volumes é é¢ï¼Œå¯ä»¥çœ‹åˆ°å¤šå‡ºä¸€é¡†æ–°çš„ Volumeï¼Œå¦‚ä¸‹åœ–çš„ç¶ æ¡† `vol-ooo`

![](img/08.jpg)


ä»¥ä¸Šæµç¨‹å°±æ˜¯ Volume1 -> Snapshot -> Volume2ï¼Œæ‰€ä»¥ Volume1 å…§å®¹ == Volume2 å…§å®¹




### æ›è¼‰ Volume è‡³æ–°çš„ EC2

æ¥è‘—é–‹ä¸€å°æ–°çš„ EC2 instance `i-ooo`ï¼Œæ–¹æ³•å¯ä»¥åƒè€ƒ [æ­¤ç¯‡](../../004 | AWS/003 | EC2-Ubuntu)

å¦‚ä¸‹åœ–ï¼Œé–‹å¥½å¾Œåœ¨ Instances é é¢çœ‹åˆ°å¤šå‡ºä¸€å°å…¨æ–°çš„ EC2 å¯¦ä¾‹ï¼Œç´…æ¡†ç‚ºåŸæœ¬çš„ EC2 instance `i-xxx`ï¼Œç¶ æ¡†ç‚ºæ–°çš„ EC2 instance `i-ooo`

![](img/09.jpg)


ç•¶ç„¶æ–°çš„ EC2 ä¸€é–‹å§‹æœƒæœ‰ä¸€é¡†é è¼‰çš„ 8G ç¡¬ç¢Ÿï¼Œæ‰€ä»¥å›åˆ° Volumes é é¢çœ‹ï¼Œä¹Ÿæœƒçœ‹åˆ°å¤šå‡ºä¾†çš„é‚£é¡†ç¡¬ç¢Ÿ

å¦‚ä¸‹åœ–ç´…è‰²ç‚ºåŸæœ¬èˆŠ EC2 instance `i-xxx` çš„ volume `vol-xxx`ï¼Œç¶ è‰²æ˜¯ clone å‡ºä¾†çš„ volume `vol-ooo`ï¼Œè—è‰²å°±æ˜¯æ–°é–‹å•Ÿçš„ EC2 instance `i-ooo` æ‰€ä½¿ç”¨çš„é è¨­çš„ volume `vol-aaa`

![](img/10.jpg)

æ¥è‘—æ›è¼‰ `vol-ooo` åˆ°å‰›å‰›é–‹å•Ÿçš„ `i-ooo` instance ä¸Šï¼Œç›´æ¥é»é¸ `vol-ooo` å³éµé¸æ“‡ `Attach Volume`

![](img/11.jpg)

å°‡ `vol-ooo` æ›è¼‰åˆ° `i-ooo` instance ä¸Šï¼Œä¸¦ä¸”è¦æ³¨æ„ä¸€ä¸‹ Device æ­¤ç¡¬ç¢Ÿçš„ç·¨è™Ÿï¼ˆç¶ æ¡†ï¼‰`sdf`ï¼Œæ›è¼‰å¥½ä¹‹å¾Œå›åˆ° Instances é é¢ä¸Šï¼Œå°‡ `i-ooo` çš„ EC2 instance åš **Reboot**

![](img/12.jpg)




### è®€å–æ›è¼‰çš„ Volume

é¦¬ä¸Šä½¿ç”¨ SSH åˆ° `i-ooo` çš„ EC2 instance ä¸Šï¼Œä¸¦ä¸”åˆ‡æ›èº«ä»½è‡³ rootï¼Œæ‰€ä»¥è¼¸å…¥æŒ‡ä»¤ `sudo -s`

![](img/13.jpg)
![](img/14.jpg)

åˆ‡æ›å¥½èº«ä»½å¾Œï¼Œè¼¸å…¥æŒ‡ä»¤ `lsblk` åˆ—å‡ºæ­¤æ©Ÿå™¨ä¸Šæœ‰å¤šå°‘é¡†ç¡¬ç¢Ÿ

ç´…æ¡†ä»£è¡¨é è¼‰çš„ 8G volume `vol-aaa`ï¼Œè€Œç¶ æ¡†å‰‡èˆŠæ˜¯é‚£åˆ» 20G çš„ `vol-ooo` volume

`xvda` ä»£è¡¨ç£ç¢Ÿ `xvda1` å‰‡æ˜¯ç¬¬ä¸€å€‹ç£å€ï¼Œè€Œ `xvdf` å‰‡å°±æ˜¯ `vol-ooo` é‚£é¡†ç£ç¢Ÿï¼Œè€Œ `xvdf1` å°±æ˜¯ä»–è£¡é¢çš„ç¬¬ä¸€å€‹ç£å€

`xvdf` èˆ‡åœ¨æ›è¼‰æ™‚ Device æ‰€æ¨™ç¤ºçš„ `sdf` å°¾æ•¸æ‡‰è©²æœƒæ˜¯ä¸€æ¨£çš„ `f`ï¼Œæ‰€ä»¥æ›è¼‰å¤šé¡†ç¡¬ç¢Ÿæ™‚è¦æ³¨æ„ä¸€ä¸‹æ‰ä¸æœƒèªéŒ¯é¡†

![](img/15.jpg)


æ¥è‘—ä¾ç„¶æ¡ç”¨ root èº«ä»½ï¼Œåœ¨ `/` **æ ¹ç›®éŒ„** ä¸‹å»ºç«‹ä¸€å€‹ `test` ç›®éŒ„

![](img/16.jpg)


å»ºç«‹å¥½ `/test` ç›®éŒ„å¾Œï¼Œå°±è¦è¨­å®šå°‡ `xvdf1` ç£å€é€£çµåˆ° `/test` ç›®éŒ„ï¼Œæ‰€ä»¥ä½¿ç”¨æŒ‡ä»¤ `mount /dev/xvdf1 /test`

æ¥è‘—å†ç”¨æŒ‡ä»¤ `lsblk` åˆ—å‡ºæ­¤æ©Ÿå™¨ä¸Šæœ‰å¤šå°‘é¡†ç¡¬ç¢Ÿ

å¦‚ä¸‹åœ–å¯ä»¥çœ‹åˆ° `xvda1` ç£å€ mount åˆ° `/` æ ¹ç›®éŒ„ï¼Œè€Œ `xvdaf` ç£å€ mount åˆ° `/test` ç›®éŒ„ï¼Œé‚£å°±ä»£è¡¨å®Œæˆäº†

![](img/17.jpg)


å¤ªå¥½äº†ï¼ç›´æ¥é€²å…¥ `/test` ç›®éŒ„å§ï¼

åˆ—å‡º `/test` ç›®éŒ„å…§çš„å…§å®¹ï¼Œå®Œå…¨çš„å¯ä»¥è®€å‡ºè³‡æ–™å°±ä»£è¡¨å®Œæˆäº†ï¼ï¼ï¼ï¼ğŸ˜‚

![](img/18.jpg)


## çµè«–

ä¸Šè¿°çš„éç¨‹æ˜¯æˆ‘è‡ªå·±çš„è™•ç†ç¶“é©—æµç¨‹ï¼Œä½†æ˜¯äº‹å¾Œç¶“ç”±æˆ‘è‡ªå·±çš„ä¸æ–·å†æ¬¡å˜—è©¦ï¼Œå…¶å¯¦æœ‰æ›´å¥½çš„è™•ç†æ–¹å¼ï¼Œæ–¹æ³•ç¸½çµå¦‚ä¸‹ï¼š

1. é—œé–‰èˆŠçš„ EC2 instance `i-xxx`
2. å°‡èˆŠçš„ Volume `vol-xxx` **Detach**(å¸ä¸‹)
3. Launch ä¸€å°æ–°çš„ EC2 instance `i-ooo`
4. å°‡å¸ä¸‹çš„ Volume `vol-xxx` **Attach**(æ›è¼‰)åˆ°æ–°çš„ EC2 instance `i-ooo`ï¼Œä¸¦ **Reboot**(é‡å•Ÿ) `i-ooo`
5. SSH ä¸Šæ–°çš„ EC2 instance `i-ooo` ä¸Šï¼Œç›´æ¥ä½¿ç”¨ **sudo** æ¬Šé™ **mount** `vol-xxx` çš„ç£å€åˆ° `/test` ç›®éŒ„
6. ä½¿ç”¨ **sudo** æ¬Šé™ä¿®æ­£ `/test/etc/ssh/sshd_config` å„²å­˜
7. **Stop**(é—œé–‰) EC2 instance `i-ooo`
8. å°‡ Volume `vol-xxx` å¾ EC2 instance `i-ooo` ä¸Š **Detach**(å¸ä¸‹)
9. å°‡Volume `vol-xxx` **Attach**(æ›è¼‰)åˆ°åŸæœ¬çš„ EC2 instance `i-xxx`ï¼Œä¸¦ **Reboot**(é‡å•Ÿ) `i-ooo`
10. å°±å¯ä»¥æˆåŠŸçš„ SSH ä¸ŠåŸæœ¬çš„ EC2 instance `i-xxx`

ä»¥ä¸Šæ˜¯æ¿ƒç¸®å†æ¿ƒç¸®ã€æéŠå†æç…‰çš„è™•ç†æ­¥é©Ÿäº†ï¼Œé›–ç„¶å‰é¢èµ°äº†å¾ˆå¤šå†¤æ—ºè·¯ï¼Œä½†æ˜¯ä¹Ÿç²å¾—äº†å¾ˆå¤šå¯¶è²´çš„æŠ€è¡“çŸ¥è­˜ ğŸ˜³


### ç›¸é—œåƒè€ƒ
* [ä½¿ Amazon EBS ç£ç¢Ÿå€å¯ä¾›åœ¨ Linux ä¸Šä½¿ç”¨ - Amazon Elastic Compute Cloud](https://docs.aws.amazon.com/zh_tw/AWSEC2/latest/UserGuide/ebs-using-volumes.html)
* [Locked myself out of Amazon EC2 SSH - This service allows sftp connections only](https://unix.stackexchange.com/questions/143925/locked-myself-out-of-amazon-ec2-ssh-this-service-allows-sftp-connections-only)
* [This service allows sftp connections only - pu20065226 - åšå®¢å›­](https://www.cnblogs.com/pu20065226/p/10962906.html)
