{"k":"EC2-Ubuntu-LetsEncrypt","t":"EC2 Ubuntu 安裝 Let's Encrypt","i":"2020-03-17","a":[{"e":"h2","t":"假設"},{"e":"ul","s":[{"e":"li","s":[{"e":"span","t":"以下操作先做假設"},{"e":"ul","s":[{"e":"li","s":[{"e":"span","t":"Elastic IPs："},{"e":"code","t":"123.456.789"}]},{"e":"li","s":[{"e":"span","t":"下載的 .pem 檔案名稱："},{"e":"code","t":"test.pem"}]},{"e":"li","s":[{"e":"code","t":"test.pem"},{"e":"span","t":" 位置："},{"e":"code","t":"/User/oa/test.pem"}]},{"e":"li","s":[{"e":"span","t":"網址(domain)："},{"e":"code","t":"your.url.tw"}]},{"e":"li","s":[{"e":"span","t":"E-Mail："},{"e":"code","t":"your.email@gmail.com"}]},{"e":"li","s":[{"e":"span","t":"以下編輯器主要是使用 "},{"e":"code","t":"nano"},{"e":"span","t":"，請自行斟酌是否使用 "},{"e":"code","t":"vi"},{"e":"span","t":" 或 "},{"e":"code","t":"vim"}]}]}]}]},{"e":"blockquote","s":[{"e":"p","s":[{"e":"span","t":"記得去你的 DNS(Domain Name Server) 設定，新增 "},{"e":"code","t":"A"},{"e":"span","t":" 紀錄 "},{"e":"code","t":"your.url.tw"},{"e":"span","t":"，指向 IP "},{"e":"code","t":"123.456.789"}]}]},{"e":"h2","t":"Let's Encrypt(ssl)"},{"e":"ul","s":[{"e":"li","s":[{"e":"span","t":"安裝 curl，指令 "},{"e":"code","t":"sudo apt install curl"}]},{"e":"li","s":[{"e":"span","t":"進入 www 目錄，指令 "},{"e":"code","t":"cd ~/www"}]},{"e":"li","s":[{"e":"span","t":"從 Git 下載最新 dehydrated，指令 "},{"e":"code","t":"git clone https://github.com/lukas2511/dehydrated.git"}]},{"e":"li","s":[{"e":"span","t":"進入專案，指令 "},{"e":"code","t":"cd dehydrated"}]},{"e":"li","s":[{"e":"span","t":"新增目錄，指令 "},{"e":"code","t":"sudo mkdir /etc/dehydrated/"}]},{"e":"li","s":[{"e":"span","t":"修改權限，指令 "},{"e":"code","t":"sudo chmod 777 /etc/dehydrated/"}]},{"e":"li","s":[{"e":"span","t":"將檔案移進去，指令 "},{"e":"code","t":"cp dehydrated /etc/dehydrated/"}]},{"e":"li","s":[{"e":"span","t":"修改 dehydrated 權限 "},{"e":"code","t":"chmod a+x /etc/dehydrated/dehydrated"}]},{"e":"li","s":[{"e":"span","t":"建立證驗時所需目錄，指令 "},{"e":"code","t":"mkdir -p /var/www/dehydrated/"}]},{"e":"li","s":[{"e":"span","t":"第一次執行同意 Let's Encrypt 的條款，指令 "},{"e":"code","t":"/etc/dehydrated/dehydrated --register --accept-terms"}]}]},{"e":"h2","t":"新增 SSL by Let's Encrypt"},{"e":"ul","s":[{"e":"li","s":[{"e":"p","s":[{"e":"span","t":"Apache，在該專案下的 "},{"e":"code","t":"http"},{"e":"span","t":" vhost 內，加入指令 "},{"e":"code","t":"Alias /.well-known/acme-challenge/ /var/www/dehydrated/"}]}]},{"e":"li","s":[{"e":"p","s":[{"e":"span","t":"nginx，在該專案下的 "},{"e":"code","t":"http"},{"e":"span","t":" vhost 中的 server 內加入以下指令："}]},{"e":"pre","s":[{"e":"code","t":"location /.well-known/acme-challenge/ {\n  alias /var/www/dehydrated/;\n}"}]}]},{"e":"li","s":[{"e":"p","s":[{"e":"span","t":"重新載入 Apache 設定，指令："},{"e":"code","t":"sudo systemctl reload apache2"}]}]},{"e":"li","s":[{"e":"p","s":[{"e":"span","t":"取得憑證 "},{"e":"code","t":"/etc/dehydrated/dehydrated -c -d your.url.tw"}]}]}]},{"e":"h2","t":"啟用 Apache SSL 功能"},{"e":"h3","t":"第一次使用"},{"e":"ul","s":[{"e":"li","s":[{"e":"p","s":[{"e":"span","t":"啟用，輸入指令："},{"e":"code","t":"sudo a2enmod ssl"}]}]},{"e":"li","s":[{"e":"p","s":[{"e":"span","t":"複製一份 ssl vhost 檔案指令 "},{"e":"code","t":"sudo cp /etc/apache2/sites-available/default-ssl.conf /etc/apache2/sites-available/my-ssl.conf"}]}]},{"e":"li","s":[{"e":"p","s":[{"e":"span","t":"啟用 "},{"e":"code","t":"my-ssl.conf"},{"e":"span","t":"，指令："},{"e":"code","t":"sudo a2ensite my-ssl.conf"}]}]},{"e":"li","s":[{"e":"p","s":[{"e":"span","t":"重新載入 Apache 設定，指令："},{"e":"code","t":"sudo systemctl reload apache2"}]}]}]},{"e":"h3","t":"不是第一次"},{"e":"ul","s":[{"e":"li","s":[{"e":"span","t":"編輯 "},{"e":"code","t":"my-ssl.conf"},{"e":"span","t":"，指令："},{"e":"code","t":"sudo nano /etc/apache2/sites-available/my-ssl.conf"},{"e":"span","t":"，可以用以下當範例："}]}]},{"e":"pre","s":[{"e":"code","t":"&lt;IfModule mod_ssl.c&gt;\n\n  &lt;VirtualHost _default_:443&gt;\n    # 你的 Domain\n    ServerName  your.url.tw\n    ServerAlias your.url.tw\n\n    # 你的 E-Mail\n    ServerAdmin your.email@gmail.com\n\n    # 你的專案目錄\n    DocumentRoot /var/www\n\n    # Log 的儲存位置\n    ErrorLog ${APACHE_LOG_DIR}/error.log\n    CustomLog ${APACHE_LOG_DIR}/access.log combined\n\n     ## SSL 設定\n    SSLEngine on\n    SSLCertificateFile /etc/dehydrated/certs/your.url.tw/cert.pem\n    SSLCertificateKeyFile /etc/dehydrated/certs/your.url.tw/privkey.pem\n    SSLCertificateChainFile /etc/dehydrated/certs/your.url.tw/chain.pem\n\n    # 記得也要是你的專案目錄\n    &lt;Directory /var/www&gt;\n      Options FollowSymLinks MultiViews\n      AllowOverride All\n      Order allow,deny\n      Allow from all\n    &lt;/Directory&gt;\n  &lt;/VirtualHost&gt;\n\n&lt;/IfModule&gt;"}]},{"e":"ul","s":[{"e":"li","s":[{"e":"span","t":"重啟 Apache 即可，指令："},{"e":"code","t":"sudo service apache2 restart"}]}]},{"e":"h3","t":"重啟錯誤"},{"e":"ul","s":[{"e":"li","s":[{"e":"p","t":"若出現以下錯誤，代表你還沒申請 ssl 的憑證檔案，所以出錯。"},{"e":"pre","s":[{"e":"code","t":"Job for apache2.service failed because the control process exited with error code.\nSee \"systemctl status apache2.service\" and \"journalctl -xe\" for details."}]}]},{"e":"li","s":[{"e":"p","s":[{"e":"span","t":"所以，先把 "},{"e":"code","t":"my-ssl.conf"},{"e":"span","t":" 停用再重開 Apache，指令："},{"e":"code","t":"sudo a2dissite my-ssl.conf"}]}]},{"e":"li","s":[{"e":"p","s":[{"e":"span","t":"重新載入 Apache 設定，指令："},{"e":"code","t":"sudo systemctl reload apache2"}]}]},{"e":"li","s":[{"e":"p","s":[{"e":"span","t":"重啟 Apache 即可，指令："},{"e":"code","t":"sudo service apache2 restart"}]}]},{"e":"li","s":[{"e":"p","s":[{"e":"span","t":"然後 執行上述的 "},{"e":"code","t":"新增 SSL by Let's Encrypt"}]}]}]},{"e":"h2","t":"以上參考："},{"e":"ul","s":[{"e":"li","s":[{"e":"p","s":[{"e":"a","attr":{"href":"http://comdan66.github.io/configs/book/mds/ec2-ubuntu/apache.html","target":"_blank"},"t":"http://comdan66.github.io/configs/book/mds/ec2-ubuntu/apache.html"}]}]},{"e":"li","s":[{"e":"p","s":[{"e":"a","attr":{"href":"https://note.artchiu.org/2016/06/17/lets-encrypt-%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E-%E9%9D%9E%E5%AE%98%E6%96%B9/","target":"_blank"},"t":"https://note.artchiu.org/2016/06/17/lets-encrypt-%E4%BD%BF%E7%94%A8%E8%AA%AA%E6%98%8E-%E9%9D%9E%E5%AE%98%E6%96%B9/"}]}]}]}],"r":[],"g":["AWS","EC2","Let's Encrypt","https"]}